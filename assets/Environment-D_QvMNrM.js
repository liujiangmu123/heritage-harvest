var Ot=Object.defineProperty;var Nt=(i,t,a)=>t in i?Ot(i,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[t]=a;var oe=(i,t,a)=>Nt(i,typeof t!="symbol"?t+"":t,a);import{u as rr,b as ur,e as Bt,_ as Dt,a as kt,c as Lt,d as kr}from"./OrbitControls-CcGKTEhn.js";import{r as V}from"./index-CIFreg_9.js";import{b as Er,Z as Ht,k as yr,D as Pt,_ as Pr,H as Me,K as Oe,$ as Ze,L as xe,a0 as tr,a1 as zt,a2 as ke,m as zr,X as Zt,P as Zr,W as Gr,a3 as hr,Y as Gt,a4 as Wt,a5 as fr,T as Ge,c as $t,a6 as Xt,a7 as Yt,a8 as Vt,a9 as qt,aa as mr,ab as Kt,ac as Qt,ad as Lr,ae as Jt,af as cr,N as jt,V as Qe,ag as ea,ah as ra,ai as ta,aj as aa}from"./three.module-C2hvsvVY.js";import{v as Wr}from"./constants-Ck1MbfUW.js";var Se=Uint8Array,Le=Uint16Array,_r=Uint32Array,$r=new Se([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Xr=new Se([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),na=new Se([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Yr=function(i,t){for(var a=new Le(31),o=0;o<31;++o)a[o]=t+=1<<i[o-1];for(var u=new _r(a[30]),o=1;o<30;++o)for(var d=a[o];d<a[o+1];++d)u[d]=d-a[o]<<5|o;return[a,u]},Vr=Yr($r,2),qr=Vr[0],ia=Vr[1];qr[28]=258,ia[258]=28;var sa=Yr(Xr,0),oa=sa[0],wr=new Le(32768);for(var j=0;j<32768;++j){var De=(j&43690)>>>1|(j&21845)<<1;De=(De&52428)>>>2|(De&13107)<<2,De=(De&61680)>>>4|(De&3855)<<4,wr[j]=((De&65280)>>>8|(De&255)<<8)>>>1}var er=function(i,t,a){for(var o=i.length,u=0,d=new Le(t);u<o;++u)++d[i[u]-1];var h=new Le(t);for(u=0;u<t;++u)h[u]=h[u-1]+d[u-1]<<1;var f;if(a){f=new Le(1<<t);var p=15-t;for(u=0;u<o;++u)if(i[u])for(var m=u<<4|i[u],C=t-i[u],R=h[i[u]-1]++<<C,x=R|(1<<C)-1;R<=x;++R)f[wr[R]>>>p]=m}else for(f=new Le(o),u=0;u<o;++u)i[u]&&(f[u]=wr[h[i[u]-1]++]>>>15-i[u]);return f},nr=new Se(288);for(var j=0;j<144;++j)nr[j]=8;for(var j=144;j<256;++j)nr[j]=9;for(var j=256;j<280;++j)nr[j]=7;for(var j=280;j<288;++j)nr[j]=8;var Kr=new Se(32);for(var j=0;j<32;++j)Kr[j]=5;var la=er(nr,9,1),ca=er(Kr,5,1),pr=function(i){for(var t=i[0],a=1;a<i.length;++a)i[a]>t&&(t=i[a]);return t},be=function(i,t,a){var o=t/8|0;return(i[o]|i[o+1]<<8)>>(t&7)&a},gr=function(i,t){var a=t/8|0;return(i[a]|i[a+1]<<8|i[a+2]<<16)>>(t&7)},ua=function(i){return(i/8|0)+(i&7&&1)},ha=function(i,t,a){(a==null||a>i.length)&&(a=i.length);var o=new(i instanceof Le?Le:i instanceof _r?_r:Se)(a-t);return o.set(i.subarray(t,a)),o},da=function(i,t,a){var o=i.length;if(!o||a&&!a.l&&o<5)return t||new Se(0);var u=!t||a,d=!a||a.i;a||(a={}),t||(t=new Se(o*3));var h=function($){var Ae=t.length;if($>Ae){var Fe=new Se(Math.max(Ae*2,$));Fe.set(t),t=Fe}},f=a.f||0,p=a.p||0,m=a.b||0,C=a.l,R=a.d,x=a.m,D=a.n,L=o*8;do{if(!C){a.f=f=be(i,p,1);var ce=be(i,p+1,3);if(p+=3,ce)if(ce==1)C=la,R=ca,x=9,D=5;else if(ce==2){var le=be(i,p,31)+257,ue=be(i,p+10,15)+4,z=le+be(i,p+5,31)+1;p+=14;for(var N=new Se(z),te=new Se(19),S=0;S<ue;++S)te[na[S]]=be(i,p+S*3,7);p+=ue*3;for(var I=pr(te),H=(1<<I)-1,W=er(te,I,1),S=0;S<z;){var k=W[be(i,p,H)];p+=k&15;var P=k>>>4;if(P<16)N[S++]=P;else{var Z=0,A=0;for(P==16?(A=3+be(i,p,3),p+=2,Z=N[S-1]):P==17?(A=3+be(i,p,7),p+=3):P==18&&(A=11+be(i,p,127),p+=7);A--;)N[S++]=Z}}var ae=N.subarray(0,le),O=N.subarray(le);x=pr(ae),D=pr(O),C=er(ae,x,1),R=er(O,D,1)}else throw"invalid block type";else{var P=ua(p)+4,ee=i[P-4]|i[P-3]<<8,re=P+ee;if(re>o){if(d)throw"unexpected EOF";break}u&&h(m+ee),t.set(i.subarray(P,re),m),a.b=m+=ee,a.p=p=re*8;continue}if(p>L){if(d)throw"unexpected EOF";break}}u&&h(m+131072);for(var Ie=(1<<x)-1,He=(1<<D)-1,Te=p;;Te=p){var Z=C[gr(i,p)&Ie],Q=Z>>>4;if(p+=Z&15,p>L){if(d)throw"unexpected EOF";break}if(!Z)throw"invalid length/literal";if(Q<256)t[m++]=Q;else if(Q==256){Te=p,C=null;break}else{var Ne=Q-254;if(Q>264){var S=Q-257,ne=$r[S];Ne=be(i,p,(1<<ne)-1)+qr[S],p+=ne}var ve=R[gr(i,p)&He],Ce=ve>>>4;if(!ve)throw"invalid distance";p+=ve&15;var O=oa[Ce];if(Ce>3){var ne=Xr[Ce];O+=gr(i,p)&(1<<ne)-1,p+=ne}if(p>L){if(d)throw"unexpected EOF";break}u&&h(m+131072);for(var $e=m+Ne;m<$e;m+=4)t[m]=t[m-O],t[m+1]=t[m+1-O],t[m+2]=t[m+2-O],t[m+3]=t[m+3-O];m=$e}}a.l=C,a.p=Te,a.b=m,C&&(f=1,a.m=x,a.d=R,a.n=D)}while(!f);return m==t.length?t:ha(t,0,m)},va=new Se(0),pa=function(i){if((i[0]&15)!=8||i[0]>>>4>7||(i[0]<<8|i[1])%31)throw"invalid zlib data";if(i[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function or(i,t){return da((pa(i),i.subarray(2,-4)),t)}var ga=typeof TextDecoder<"u"&&new TextDecoder,fa=0;try{ga.decode(va,{stream:!0}),fa=1}catch{}const ma=i=>i&&i.isCubeTexture;class _a extends Er{constructor(t,a){var o,u;const d=ma(t),f=((u=d?(o=t.image[0])==null?void 0:o.width:t.image.width)!=null?u:1024)/4,p=Math.floor(Math.log2(f)),m=Math.pow(2,p),C=3*Math.max(m,16*7),R=4*m,x=[d?"#define ENVMAP_TYPE_CUBE":"",`#define CUBEUV_TEXEL_WIDTH ${1/C}`,`#define CUBEUV_TEXEL_HEIGHT ${1/R}`,`#define CUBEUV_MAX_MIP ${p}.0`],D=`
        varying vec3 vWorldPosition;
        void main() 
        {
            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );
            vWorldPosition = worldPosition.xyz;
            
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
        `,L=x.join(`
`)+`
        #define ENVMAP_TYPE_CUBE_UV
        varying vec3 vWorldPosition;
        uniform float radius;
        uniform float height;
        uniform float angle;
        #ifdef ENVMAP_TYPE_CUBE
            uniform samplerCube map;
        #else
            uniform sampler2D map;
        #endif
        // From: https://www.shadertoy.com/view/4tsBD7
        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) 
        {
            float d = dot ( rd, n );
            
            if( d > 0.0 ) { return 1e6; }
            
            vec3  o = ro - c;
            float t = - dot( n, o ) / d;
            vec3  q = o + rd * t;
            
            return ( dot( q, q ) < r * r ) ? t : 1e6;
        }
        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm
        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) 
        {
            vec3 oc = ro - ce;
            float b = dot( oc, rd );
            float c = dot( oc, oc ) - ra * ra;
            float h = b * b - c;
            
            if( h < 0.0 ) { return -1.0; }
            
            h = sqrt( h );
            
            return - b + h;
        }
        vec3 project() 
        {
            vec3 p = normalize( vWorldPosition );
            vec3 camPos = cameraPosition;
            camPos.y -= height;
            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );
            if( intersection > 0.0 ) {
                
                vec3 h = vec3( 0.0, - height, 0.0 );
                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );
                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;
            } else {
                p = vec3( 0.0, 1.0, 0.0 );
            }
            return p;
        }
        #include <common>
        #include <cube_uv_reflection_fragment>
        void main() 
        {
            vec3 projectedWorldPosition = project();
            
            #ifdef ENVMAP_TYPE_CUBE
                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;
            #else
                vec3 direction = normalize( projectedWorldPosition );
                vec2 uv = equirectUv( direction );
                vec3 outcolor = texture2D( map, uv ).rgb;
            #endif
            gl_FragColor = vec4( outcolor, 1.0 );
            #include <tonemapping_fragment>
            #include <${Wr>=154?"colorspace_fragment":"encodings_fragment"}>
        }
        `,ce={map:{value:t},height:{value:(a==null?void 0:a.height)||15},radius:{value:(a==null?void 0:a.radius)||100}},P=new Ht(1,16),ee=new yr({uniforms:ce,fragmentShader:L,vertexShader:D,side:Pt});super(P,ee)}set radius(t){this.material.uniforms.radius.value=t}get radius(){return this.material.uniforms.radius.value}set height(t){this.material.uniforms.height.value=t}get height(){return this.material.uniforms.height.value}}class wa extends Pr{constructor(t){super(t),this.type=Me}parse(t){const h=function(S,I){switch(S){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(I||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(I||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(I||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(I||""))}},C=`
`,R=function(S,I,H){I=I||1024;let k=S.pos,Z=-1,A=0,ae="",O=String.fromCharCode.apply(null,new Uint16Array(S.subarray(k,k+128)));for(;0>(Z=O.indexOf(C))&&A<I&&k<S.byteLength;)ae+=O,A+=O.length,k+=128,O+=String.fromCharCode.apply(null,new Uint16Array(S.subarray(k,k+128)));return-1<Z?(S.pos+=A+Z+1,ae+O.slice(0,Z)):!1},x=function(S){const I=/^#\?(\S+)/,H=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,W=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,k=/^\s*FORMAT=(\S+)\s*$/,Z=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,A={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let ae,O;for((S.pos>=S.byteLength||!(ae=R(S)))&&h(1,"no header found"),(O=ae.match(I))||h(3,"bad initial token"),A.valid|=1,A.programtype=O[1],A.string+=ae+`
`;ae=R(S),ae!==!1;){if(A.string+=ae+`
`,ae.charAt(0)==="#"){A.comments+=ae+`
`;continue}if((O=ae.match(H))&&(A.gamma=parseFloat(O[1])),(O=ae.match(W))&&(A.exposure=parseFloat(O[1])),(O=ae.match(k))&&(A.valid|=2,A.format=O[1]),(O=ae.match(Z))&&(A.valid|=4,A.height=parseInt(O[1],10),A.width=parseInt(O[2],10)),A.valid&2&&A.valid&4)break}return A.valid&2||h(3,"missing format specifier"),A.valid&4||h(3,"missing image size specifier"),A},D=function(S,I,H){const W=I;if(W<8||W>32767||S[0]!==2||S[1]!==2||S[2]&128)return new Uint8Array(S);W!==(S[2]<<8|S[3])&&h(3,"wrong scanline width");const k=new Uint8Array(4*I*H);k.length||h(4,"unable to allocate buffer space");let Z=0,A=0;const ae=4*W,O=new Uint8Array(4),Ie=new Uint8Array(ae);let He=H;for(;He>0&&A<S.byteLength;){A+4>S.byteLength&&h(1),O[0]=S[A++],O[1]=S[A++],O[2]=S[A++],O[3]=S[A++],(O[0]!=2||O[1]!=2||(O[2]<<8|O[3])!=W)&&h(3,"bad rgbe scanline format");let Te=0,Q;for(;Te<ae&&A<S.byteLength;){Q=S[A++];const ne=Q>128;if(ne&&(Q-=128),(Q===0||Te+Q>ae)&&h(3,"bad scanline data"),ne){const ve=S[A++];for(let Ce=0;Ce<Q;Ce++)Ie[Te++]=ve}else Ie.set(S.subarray(A,A+Q),Te),Te+=Q,A+=Q}const Ne=W;for(let ne=0;ne<Ne;ne++){let ve=0;k[Z]=Ie[ne+ve],ve+=W,k[Z+1]=Ie[ne+ve],ve+=W,k[Z+2]=Ie[ne+ve],ve+=W,k[Z+3]=Ie[ne+ve],Z+=4}He--}return k},L=function(S,I,H,W){const k=S[I+3],Z=Math.pow(2,k-128)/255;H[W+0]=S[I+0]*Z,H[W+1]=S[I+1]*Z,H[W+2]=S[I+2]*Z,H[W+3]=1},ce=function(S,I,H,W){const k=S[I+3],Z=Math.pow(2,k-128)/255;H[W+0]=Ze.toHalfFloat(Math.min(S[I+0]*Z,65504)),H[W+1]=Ze.toHalfFloat(Math.min(S[I+1]*Z,65504)),H[W+2]=Ze.toHalfFloat(Math.min(S[I+2]*Z,65504)),H[W+3]=Ze.toHalfFloat(1)},P=new Uint8Array(t);P.pos=0;const ee=x(P),re=ee.width,le=ee.height,ue=D(P.subarray(P.pos),re,le);let z,N,te;switch(this.type){case Oe:te=ue.length/4;const S=new Float32Array(te*4);for(let H=0;H<te;H++)L(ue,H*4,S,H*4);z=S,N=Oe;break;case Me:te=ue.length/4;const I=new Uint16Array(te*4);for(let H=0;H<te;H++)ce(ue,H*4,I,H*4);z=I,N=Me;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:re,height:le,data:z,header:ee.string,gamma:ee.gamma,exposure:ee.exposure,type:N}}setDataType(t){return this.type=t,this}load(t,a,o,u){function d(h,f){switch(h.type){case Oe:case Me:"colorSpace"in h?h.colorSpace="srgb-linear":h.encoding=3e3,h.minFilter=xe,h.magFilter=xe,h.generateMipmaps=!1,h.flipY=!0;break}a&&a(h,f)}return super.load(t,d,o,u)}}const Je=Wr>=152;class Ea extends Pr{constructor(t){super(t),this.type=Me}parse(t){const I=Math.pow(2.7182818,2.2);function H(e,r){for(var n=0,s=0;s<65536;++s)(s==0||e[s>>3]&1<<(s&7))&&(r[n++]=s);for(var l=n-1;n<65536;)r[n++]=0;return l}function W(e){for(var r=0;r<16384;r++)e[r]={},e[r].len=0,e[r].lit=0,e[r].p=null}const k={l:0,c:0,lc:0};function Z(e,r,n,s,l){for(;n<e;)r=r<<8|Br(s,l),n+=8;n-=e,k.l=r>>n&(1<<e)-1,k.c=r,k.lc=n}const A=new Array(59);function ae(e){for(var r=0;r<=58;++r)A[r]=0;for(var r=0;r<65537;++r)A[e[r]]+=1;for(var n=0,r=58;r>0;--r){var s=n+A[r]>>1;A[r]=n,n=s}for(var r=0;r<65537;++r){var l=e[r];l>0&&(e[r]=l|A[l]++<<6)}}function O(e,r,n,s,l,c,g){for(var v=n,E=0,w=0;l<=c;l++){if(v.value-n.value>s)return!1;Z(6,E,w,e,v);var y=k.l;if(E=k.c,w=k.lc,g[l]=y,y==63){if(v.value-n.value>s)throw"Something wrong with hufUnpackEncTable";Z(8,E,w,e,v);var _=k.l+6;if(E=k.c,w=k.lc,l+_>c+1)throw"Something wrong with hufUnpackEncTable";for(;_--;)g[l++]=0;l--}else if(y>=59){var _=y-59+2;if(l+_>c+1)throw"Something wrong with hufUnpackEncTable";for(;_--;)g[l++]=0;l--}}ae(g)}function Ie(e){return e&63}function He(e){return e>>6}function Te(e,r,n,s){for(;r<=n;r++){var l=He(e[r]),c=Ie(e[r]);if(l>>c)throw"Invalid table entry";if(c>14){var g=s[l>>c-14];if(g.len)throw"Invalid table entry";if(g.lit++,g.p){var v=g.p;g.p=new Array(g.lit);for(var E=0;E<g.lit-1;++E)g.p[E]=v[E]}else g.p=new Array(1);g.p[g.lit-1]=r}else if(c)for(var w=0,E=1<<14-c;E>0;E--){var g=s[(l<<14-c)+w];if(g.len||g.p)throw"Invalid table entry";g.len=c,g.lit=r,w++}}return!0}const Q={c:0,lc:0};function Ne(e,r,n,s){e=e<<8|Br(n,s),r+=8,Q.c=e,Q.lc=r}const ne={c:0,lc:0};function ve(e,r,n,s,l,c,g,v,E,w){if(e==r){s<8&&(Ne(n,s,l,g),n=Q.c,s=Q.lc),s-=8;var y=n>>s,y=new Uint8Array([y])[0];if(E.value+y>w)return!1;for(var _=v[E.value-1];y-- >0;)v[E.value++]=_}else if(E.value<w)v[E.value++]=e;else return!1;ne.c=n,ne.lc=s}function Ce(e){return e&65535}function $e(e){var r=Ce(e);return r>32767?r-65536:r}const $={a:0,b:0};function Ae(e,r){var n=$e(e),s=$e(r),l=s,c=n+(l&1)+(l>>1),g=c,v=c-l;$.a=g,$.b=v}function Fe(e,r){var n=Ce(e),s=Ce(r),l=n-(s>>1)&65535,c=s+l-32768&65535;$.a=c,$.b=l}function at(e,r,n,s,l,c,g){for(var v=g<16384,E=n>l?l:n,w=1,y;w<=E;)w<<=1;for(w>>=1,y=w,w>>=1;w>=1;){for(var _=0,se=_+c*(l-y),T=c*w,b=c*y,F=s*w,U=s*y,X,q,he,fe;_<=se;_+=b){for(var K=_,Re=_+s*(n-y);K<=Re;K+=U){var J=K+F,de=K+T,Ue=de+F;v?(Ae(e[K+r],e[de+r]),X=$.a,he=$.b,Ae(e[J+r],e[Ue+r]),q=$.a,fe=$.b,Ae(X,q),e[K+r]=$.a,e[J+r]=$.b,Ae(he,fe),e[de+r]=$.a,e[Ue+r]=$.b):(Fe(e[K+r],e[de+r]),X=$.a,he=$.b,Fe(e[J+r],e[Ue+r]),q=$.a,fe=$.b,Fe(X,q),e[K+r]=$.a,e[J+r]=$.b,Fe(he,fe),e[de+r]=$.a,e[Ue+r]=$.b)}if(n&w){var de=K+T;v?Ae(e[K+r],e[de+r]):Fe(e[K+r],e[de+r]),X=$.a,e[de+r]=$.b,e[K+r]=X}}if(l&w)for(var K=_,Re=_+s*(n-y);K<=Re;K+=U){var J=K+F;v?Ae(e[K+r],e[J+r]):Fe(e[K+r],e[J+r]),X=$.a,e[J+r]=$.b,e[K+r]=X}y=w,w>>=1}return _}function nt(e,r,n,s,l,c,g,v,E,w){for(var y=0,_=0,se=v,T=Math.trunc(l.value+(c+7)/8);l.value<T;)for(Ne(y,_,n,l),y=Q.c,_=Q.lc;_>=14;){var b=y>>_-14&16383,F=r[b];if(F.len)_-=F.len,ve(F.lit,g,y,_,n,s,l,E,w,se),y=ne.c,_=ne.lc;else{if(!F.p)throw"hufDecode issues";var U;for(U=0;U<F.lit;U++){for(var X=Ie(e[F.p[U]]);_<X&&l.value<T;)Ne(y,_,n,l),y=Q.c,_=Q.lc;if(_>=X&&He(e[F.p[U]])==(y>>_-X&(1<<X)-1)){_-=X,ve(F.p[U],g,y,_,n,s,l,E,w,se),y=ne.c,_=ne.lc;break}}if(U==F.lit)throw"hufDecode issues"}}var q=8-c&7;for(y>>=q,_-=q;_>0;){var F=r[y<<14-_&16383];if(F.len)_-=F.len,ve(F.lit,g,y,_,n,s,l,E,w,se),y=ne.c,_=ne.lc;else throw"hufDecode issues"}return!0}function xr(e,r,n,s,l,c){var g={value:0},v=n.value,E=me(r,n),w=me(r,n);n.value+=4;var y=me(r,n);if(n.value+=4,E<0||E>=65537||w<0||w>=65537)throw"Something wrong with HUF_ENCSIZE";var _=new Array(65537),se=new Array(16384);W(se);var T=s-(n.value-v);if(O(e,r,n,T,E,w,_),y>8*(s-(n.value-v)))throw"Something wrong with hufUncompress";Te(_,E,w,se),nt(_,se,e,r,n,y,w,c,l,g)}function it(e,r,n){for(var s=0;s<n;++s)r[s]=e[r[s]]}function Ar(e){for(var r=1;r<e.length;r++){var n=e[r-1]+e[r]-128;e[r]=n}}function Fr(e,r){for(var n=0,s=Math.floor((e.length+1)/2),l=0,c=e.length-1;!(l>c||(r[l++]=e[n++],l>c));)r[l++]=e[s++]}function Ur(e){for(var r=e.byteLength,n=new Array,s=0,l=new DataView(e);r>0;){var c=l.getInt8(s++);if(c<0){var g=-c;r-=g+1;for(var v=0;v<g;v++)n.push(l.getUint8(s++))}else{var g=c;r-=2;for(var E=l.getUint8(s++),v=0;v<g+1;v++)n.push(E)}}return n}function st(e,r,n,s,l,c){var J=new DataView(c.buffer),g=n[e.idx[0]].width,v=n[e.idx[0]].height,E=3,w=Math.floor(g/8),y=Math.ceil(g/8),_=Math.ceil(v/8),se=g-(y-1)*8,T=v-(_-1)*8,b={value:0},F=new Array(E),U=new Array(E),X=new Array(E),q=new Array(E),he=new Array(E);for(let Y=0;Y<E;++Y)he[Y]=r[e.idx[Y]],F[Y]=Y<1?0:F[Y-1]+y*_,U[Y]=new Float32Array(64),X[Y]=new Uint16Array(64),q[Y]=new Uint16Array(y*64);for(let Y=0;Y<_;++Y){var fe=8;Y==_-1&&(fe=T);var K=8;for(let ie=0;ie<y;++ie){ie==y-1&&(K=se);for(let G=0;G<E;++G)X[G].fill(0),X[G][0]=l[F[G]++],ot(b,s,X[G]),lt(X[G],U[G]),ct(U[G]);ut(U);for(let G=0;G<E;++G)ht(U[G],q[G],ie*64)}let ge=0;for(let ie=0;ie<E;++ie){const G=n[e.idx[ie]].type;for(let ye=8*Y;ye<8*Y+fe;++ye){ge=he[ie][ye];for(let Pe=0;Pe<w;++Pe){const _e=Pe*64+(ye&7)*8;J.setUint16(ge+0*2*G,q[ie][_e+0],!0),J.setUint16(ge+1*2*G,q[ie][_e+1],!0),J.setUint16(ge+2*2*G,q[ie][_e+2],!0),J.setUint16(ge+3*2*G,q[ie][_e+3],!0),J.setUint16(ge+4*2*G,q[ie][_e+4],!0),J.setUint16(ge+5*2*G,q[ie][_e+5],!0),J.setUint16(ge+6*2*G,q[ie][_e+6],!0),J.setUint16(ge+7*2*G,q[ie][_e+7],!0),ge+=8*2*G}}if(w!=y)for(let ye=8*Y;ye<8*Y+fe;++ye){const Pe=he[ie][ye]+8*w*2*G,_e=w*64+(ye&7)*8;for(let Be=0;Be<K;++Be)J.setUint16(Pe+Be*2*G,q[ie][_e+Be],!0)}}}for(var Re=new Uint16Array(g),J=new DataView(c.buffer),de=0;de<E;++de){n[e.idx[de]].decoded=!0;var Ue=n[e.idx[de]].type;if(n[de].type==2)for(var Ke=0;Ke<v;++Ke){const Y=he[de][Ke];for(var Ee=0;Ee<g;++Ee)Re[Ee]=J.getUint16(Y+Ee*2*Ue,!0);for(var Ee=0;Ee<g;++Ee)J.setFloat32(Y+Ee*2*Ue,M(Re[Ee]),!0)}}}function ot(e,r,n){for(var s,l=1;l<64;)s=r[e.value],s==65280?l=64:s>>8==255?l+=s&255:(n[l]=s,l++),e.value++}function lt(e,r){r[0]=M(e[0]),r[1]=M(e[1]),r[2]=M(e[5]),r[3]=M(e[6]),r[4]=M(e[14]),r[5]=M(e[15]),r[6]=M(e[27]),r[7]=M(e[28]),r[8]=M(e[2]),r[9]=M(e[4]),r[10]=M(e[7]),r[11]=M(e[13]),r[12]=M(e[16]),r[13]=M(e[26]),r[14]=M(e[29]),r[15]=M(e[42]),r[16]=M(e[3]),r[17]=M(e[8]),r[18]=M(e[12]),r[19]=M(e[17]),r[20]=M(e[25]),r[21]=M(e[30]),r[22]=M(e[41]),r[23]=M(e[43]),r[24]=M(e[9]),r[25]=M(e[11]),r[26]=M(e[18]),r[27]=M(e[24]),r[28]=M(e[31]),r[29]=M(e[40]),r[30]=M(e[44]),r[31]=M(e[53]),r[32]=M(e[10]),r[33]=M(e[19]),r[34]=M(e[23]),r[35]=M(e[32]),r[36]=M(e[39]),r[37]=M(e[45]),r[38]=M(e[52]),r[39]=M(e[54]),r[40]=M(e[20]),r[41]=M(e[22]),r[42]=M(e[33]),r[43]=M(e[38]),r[44]=M(e[46]),r[45]=M(e[51]),r[46]=M(e[55]),r[47]=M(e[60]),r[48]=M(e[21]),r[49]=M(e[34]),r[50]=M(e[37]),r[51]=M(e[47]),r[52]=M(e[50]),r[53]=M(e[56]),r[54]=M(e[59]),r[55]=M(e[61]),r[56]=M(e[35]),r[57]=M(e[36]),r[58]=M(e[48]),r[59]=M(e[49]),r[60]=M(e[57]),r[61]=M(e[58]),r[62]=M(e[62]),r[63]=M(e[63])}function ct(e){const r=.5*Math.cos(.7853975),n=.5*Math.cos(3.14159/16),s=.5*Math.cos(3.14159/8),l=.5*Math.cos(3*3.14159/16),c=.5*Math.cos(5*3.14159/16),g=.5*Math.cos(3*3.14159/8),v=.5*Math.cos(7*3.14159/16);for(var E=new Array(4),w=new Array(4),y=new Array(4),_=new Array(4),se=0;se<8;++se){var T=se*8;E[0]=s*e[T+2],E[1]=g*e[T+2],E[2]=s*e[T+6],E[3]=g*e[T+6],w[0]=n*e[T+1]+l*e[T+3]+c*e[T+5]+v*e[T+7],w[1]=l*e[T+1]-v*e[T+3]-n*e[T+5]-c*e[T+7],w[2]=c*e[T+1]-n*e[T+3]+v*e[T+5]+l*e[T+7],w[3]=v*e[T+1]-c*e[T+3]+l*e[T+5]-n*e[T+7],y[0]=r*(e[T+0]+e[T+4]),y[3]=r*(e[T+0]-e[T+4]),y[1]=E[0]+E[3],y[2]=E[1]-E[2],_[0]=y[0]+y[1],_[1]=y[3]+y[2],_[2]=y[3]-y[2],_[3]=y[0]-y[1],e[T+0]=_[0]+w[0],e[T+1]=_[1]+w[1],e[T+2]=_[2]+w[2],e[T+3]=_[3]+w[3],e[T+4]=_[3]-w[3],e[T+5]=_[2]-w[2],e[T+6]=_[1]-w[1],e[T+7]=_[0]-w[0]}for(var b=0;b<8;++b)E[0]=s*e[16+b],E[1]=g*e[16+b],E[2]=s*e[48+b],E[3]=g*e[48+b],w[0]=n*e[8+b]+l*e[24+b]+c*e[40+b]+v*e[56+b],w[1]=l*e[8+b]-v*e[24+b]-n*e[40+b]-c*e[56+b],w[2]=c*e[8+b]-n*e[24+b]+v*e[40+b]+l*e[56+b],w[3]=v*e[8+b]-c*e[24+b]+l*e[40+b]-n*e[56+b],y[0]=r*(e[b]+e[32+b]),y[3]=r*(e[b]-e[32+b]),y[1]=E[0]+E[3],y[2]=E[1]-E[2],_[0]=y[0]+y[1],_[1]=y[3]+y[2],_[2]=y[3]-y[2],_[3]=y[0]-y[1],e[0+b]=_[0]+w[0],e[8+b]=_[1]+w[1],e[16+b]=_[2]+w[2],e[24+b]=_[3]+w[3],e[32+b]=_[3]-w[3],e[40+b]=_[2]-w[2],e[48+b]=_[1]-w[1],e[56+b]=_[0]-w[0]}function ut(e){for(var r=0;r<64;++r){var n=e[0][r],s=e[1][r],l=e[2][r];e[0][r]=n+1.5747*l,e[1][r]=n-.1873*s-.4682*l,e[2][r]=n+1.8556*s}}function ht(e,r,n){for(var s=0;s<64;++s)r[n+s]=Ze.toHalfFloat(dt(e[s]))}function dt(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(I,Math.abs(e)-1)}function Or(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function vt(e){var r=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),n=new Uint8Array(Ur(r)),s=new Uint8Array(n.length);return Ar(n),Fr(n,s),new DataView(s.buffer)}function vr(e){var r=e.array.slice(e.offset.value,e.offset.value+e.size),n=or(r),s=new Uint8Array(n.length);return Ar(n),Fr(n,s),new DataView(s.buffer)}function pt(e){for(var r=e.viewer,n={value:e.offset.value},s=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),l=new Uint8Array(8192),c=0,g=new Array(e.channels),v=0;v<e.channels;v++)g[v]={},g[v].start=c,g[v].end=g[v].start,g[v].nx=e.width,g[v].ny=e.lines,g[v].size=e.type,c+=g[v].nx*g[v].ny*g[v].size;var E=Ye(r,n),w=Ye(r,n);if(w>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(E<=w)for(var v=0;v<w-E+1;v++)l[v+E]=ze(r,n);var y=new Uint16Array(65536),_=H(l,y),se=me(r,n);xr(e.array,r,n,se,s,c);for(var v=0;v<e.channels;++v)for(var T=g[v],b=0;b<g[v].size;++b)at(s,T.start+b,T.nx,T.size,T.ny,T.nx*T.size,_);it(y,s,c);for(var F=0,U=new Uint8Array(s.buffer.byteLength),X=0;X<e.lines;X++)for(var q=0;q<e.channels;q++){var T=g[q],he=T.nx*T.size,fe=new Uint8Array(s.buffer,T.end*2,he*2);U.set(fe,F),F+=he*2,T.end+=he}return new DataView(U.buffer)}function gt(e){var r=e.array.slice(e.offset.value,e.offset.value+e.size),n=or(r);const s=e.lines*e.channels*e.width,l=e.type==1?new Uint16Array(s):new Uint32Array(s);let c=0,g=0;const v=new Array(4);for(let E=0;E<e.lines;E++)for(let w=0;w<e.channels;w++){let y=0;switch(e.type){case 1:v[0]=c,v[1]=v[0]+e.width,c=v[1]+e.width;for(let _=0;_<e.width;++_){const se=n[v[0]++]<<8|n[v[1]++];y+=se,l[g]=y,g++}break;case 2:v[0]=c,v[1]=v[0]+e.width,v[2]=v[1]+e.width,c=v[2]+e.width;for(let _=0;_<e.width;++_){const se=n[v[0]++]<<24|n[v[1]++]<<16|n[v[2]++]<<8;y+=se,l[g]=y,g++}break}}return new DataView(l.buffer)}function Nr(e){var r=e.viewer,n={value:e.offset.value},s=new Uint8Array(e.width*e.lines*(e.channels*e.type*2)),l={version:we(r,n),unknownUncompressedSize:we(r,n),unknownCompressedSize:we(r,n),acCompressedSize:we(r,n),dcCompressedSize:we(r,n),rleCompressedSize:we(r,n),rleUncompressedSize:we(r,n),rleRawSize:we(r,n),totalAcUncompressedCount:we(r,n),totalDcUncompressedCount:we(r,n),acCompression:we(r,n)};if(l.version<2)throw"EXRLoader.parse: "+qe.compression+" version "+l.version+" is unsupported";for(var c=new Array,g=Ye(r,n)-2;g>0;){var v=ir(r.buffer,n),E=ze(r,n),w=E>>2&3,y=(E>>4)-1,_=new Int8Array([y])[0],se=ze(r,n);c.push({name:v,index:_,type:se,compression:w}),g-=v.length+3}for(var T=qe.channels,b=new Array(e.channels),F=0;F<e.channels;++F){var U=b[F]={},X=T[F];U.name=X.name,U.compression=0,U.decoded=!1,U.type=X.pixelType,U.pLinear=X.pLinear,U.width=e.width,U.height=e.lines}for(var q={idx:new Array(3)},he=0;he<e.channels;++he)for(var U=b[he],F=0;F<c.length;++F){var fe=c[F];U.name==fe.name&&(U.compression=fe.compression,fe.index>=0&&(q.idx[fe.index]=he),U.offset=he)}if(l.acCompressedSize>0)switch(l.acCompression){case 0:var J=new Uint16Array(l.totalAcUncompressedCount);xr(e.array,r,n,l.acCompressedSize,J,l.totalAcUncompressedCount);break;case 1:var K=e.array.slice(n.value,n.value+l.totalAcUncompressedCount),Re=or(K),J=new Uint16Array(Re.buffer);n.value+=l.totalAcUncompressedCount;break}if(l.dcCompressedSize>0){var de={array:e.array,offset:n,size:l.dcCompressedSize},Ue=new Uint16Array(vr(de).buffer);n.value+=l.dcCompressedSize}if(l.rleRawSize>0){var K=e.array.slice(n.value,n.value+l.rleCompressedSize),Re=or(K),Ke=Ur(Re.buffer);n.value+=l.rleCompressedSize}for(var Ee=0,Y=new Array(b.length),F=0;F<Y.length;++F)Y[F]=new Array;for(var ge=0;ge<e.lines;++ge)for(var ie=0;ie<b.length;++ie)Y[ie].push(Ee),Ee+=b[ie].width*e.type*2;st(q,Y,b,J,Ue,s);for(var F=0;F<b.length;++F){var U=b[F];if(!U.decoded)switch(U.compression){case 2:for(var G=0,ye=0,ge=0;ge<e.lines;++ge){for(var Pe=Y[F][G],_e=0;_e<U.width;++_e){for(var Be=0;Be<2*U.type;++Be)s[Pe++]=Ke[ye+Be*U.width*U.height];ye++}G++}break;case 1:default:throw"EXRLoader.parse: unsupported channel compression"}}return new DataView(s.buffer)}function ir(e,r){for(var n=new Uint8Array(e),s=0;n[r.value+s]!=0;)s+=1;var l=new TextDecoder().decode(n.slice(r.value,r.value+s));return r.value=r.value+s+1,l}function ft(e,r,n){var s=new TextDecoder().decode(new Uint8Array(e).slice(r.value,r.value+n));return r.value=r.value+n,s}function mt(e,r){var n=Xe(e,r),s=me(e,r);return[n,s]}function _t(e,r){var n=me(e,r),s=me(e,r);return[n,s]}function Xe(e,r){var n=e.getInt32(r.value,!0);return r.value=r.value+4,n}function me(e,r){var n=e.getUint32(r.value,!0);return r.value=r.value+4,n}function Br(e,r){var n=e[r.value];return r.value=r.value+1,n}function ze(e,r){var n=e.getUint8(r.value);return r.value=r.value+1,n}const we=function(e,r){let n;return"getBigInt64"in DataView.prototype?n=Number(e.getBigInt64(r.value,!0)):n=e.getUint32(r.value+4,!0)+Number(e.getUint32(r.value,!0)<<32),r.value+=8,n};function pe(e,r){var n=e.getFloat32(r.value,!0);return r.value+=4,n}function wt(e,r){return Ze.toHalfFloat(pe(e,r))}function M(e){var r=(e&31744)>>10,n=e&1023;return(e>>15?-1:1)*(r?r===31?n?NaN:1/0:Math.pow(2,r-15)*(1+n/1024):6103515625e-14*(n/1024))}function Ye(e,r){var n=e.getUint16(r.value,!0);return r.value+=2,n}function Et(e,r){return M(Ye(e,r))}function yt(e,r,n,s){for(var l=n.value,c=[];n.value<l+s-1;){var g=ir(r,n),v=Xe(e,n),E=ze(e,n);n.value+=3;var w=Xe(e,n),y=Xe(e,n);c.push({name:g,pixelType:v,pLinear:E,xSampling:w,ySampling:y})}return n.value+=1,c}function St(e,r){var n=pe(e,r),s=pe(e,r),l=pe(e,r),c=pe(e,r),g=pe(e,r),v=pe(e,r),E=pe(e,r),w=pe(e,r);return{redX:n,redY:s,greenX:l,greenY:c,blueX:g,blueY:v,whiteX:E,whiteY:w}}function Mt(e,r){var n=["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"],s=ze(e,r);return n[s]}function It(e,r){var n=me(e,r),s=me(e,r),l=me(e,r),c=me(e,r);return{xMin:n,yMin:s,xMax:l,yMax:c}}function Tt(e,r){var n=["INCREASING_Y"],s=ze(e,r);return n[s]}function bt(e,r){var n=pe(e,r),s=pe(e,r);return[n,s]}function Ct(e,r){var n=pe(e,r),s=pe(e,r),l=pe(e,r);return[n,s,l]}function Rt(e,r,n,s,l){if(s==="string"||s==="stringvector"||s==="iccProfile")return ft(r,n,l);if(s==="chlist")return yt(e,r,n,l);if(s==="chromaticities")return St(e,n);if(s==="compression")return Mt(e,n);if(s==="box2i")return It(e,n);if(s==="lineOrder")return Tt(e,n);if(s==="float")return pe(e,n);if(s==="v2f")return bt(e,n);if(s==="v3f")return Ct(e,n);if(s==="int")return Xe(e,n);if(s==="rational")return mt(e,n);if(s==="timecode")return _t(e,n);if(s==="preview")return n.value+=l,"skipped";n.value+=l}function xt(e,r,n){const s={};if(e.getUint32(0,!0)!=20000630)throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";s.version=e.getUint8(4);const l=e.getUint8(5);s.spec={singleTile:!!(l&2),longName:!!(l&4),deepFormat:!!(l&8),multiPart:!!(l&16)},n.value=8;for(var c=!0;c;){var g=ir(r,n);if(g==0)c=!1;else{var v=ir(r,n),E=me(e,n),w=Rt(e,r,n,v,E);w===void 0?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${v}'.`):s[g]=w}}if(l&-5)throw console.error("EXRHeader:",s),"THREE.EXRLoader: provided file is currently unsupported.";return s}function At(e,r,n,s,l){const c={size:0,viewer:r,array:n,offset:s,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:e.channels[0].pixelType,uncompress:null,getter:null,format:null,[Je?"colorSpace":"encoding"]:null};switch(e.compression){case"NO_COMPRESSION":c.lines=1,c.uncompress=Or;break;case"RLE_COMPRESSION":c.lines=1,c.uncompress=vt;break;case"ZIPS_COMPRESSION":c.lines=1,c.uncompress=vr;break;case"ZIP_COMPRESSION":c.lines=16,c.uncompress=vr;break;case"PIZ_COMPRESSION":c.lines=32,c.uncompress=pt;break;case"PXR24_COMPRESSION":c.lines=16,c.uncompress=gt;break;case"DWAA_COMPRESSION":c.lines=32,c.uncompress=Nr;break;case"DWAB_COMPRESSION":c.lines=256,c.uncompress=Nr;break;default:throw"EXRLoader.parse: "+e.compression+" is unsupported"}if(c.scanlineBlockSize=c.lines,c.type==1)switch(l){case Oe:c.getter=Et,c.inputSize=2;break;case Me:c.getter=Ye,c.inputSize=2;break}else if(c.type==2)switch(l){case Oe:c.getter=pe,c.inputSize=4;break;case Me:c.getter=wt,c.inputSize=4}else throw"EXRLoader.parse: unsupported pixelType "+c.type+" for "+e.compression+".";c.blockCount=(e.dataWindow.yMax+1)/c.scanlineBlockSize;for(var g=0;g<c.blockCount;g++)we(r,s);c.outputChannels=c.channels==3?4:c.channels;const v=c.width*c.height*c.outputChannels;switch(l){case Oe:c.byteArray=new Float32Array(v),c.channels<c.outputChannels&&c.byteArray.fill(1,0,v);break;case Me:c.byteArray=new Uint16Array(v),c.channels<c.outputChannels&&c.byteArray.fill(15360,0,v);break;default:console.error("THREE.EXRLoader: unsupported type: ",l);break}return c.bytesPerLine=c.width*c.inputSize*c.channels,c.outputChannels==4?c.format=tr:c.format=zt,Je?c.colorSpace="srgb-linear":c.encoding=3e3,c}const sr=new DataView(t),Ft=new Uint8Array(t),Ve={value:0},qe=xt(sr,t,Ve),B=At(qe,sr,Ft,Ve,this.type),Dr={value:0},Ut={R:0,G:1,B:2,A:3,Y:0};for(let e=0;e<B.height/B.scanlineBlockSize;e++){const r=me(sr,Ve);B.size=me(sr,Ve),B.lines=r+B.scanlineBlockSize>B.height?B.height-r:B.scanlineBlockSize;const s=B.size<B.lines*B.bytesPerLine?B.uncompress(B):Or(B);Ve.value+=B.size;for(let l=0;l<B.scanlineBlockSize;l++){const c=l+e*B.scanlineBlockSize;if(c>=B.height)break;for(let g=0;g<B.channels;g++){const v=Ut[qe.channels[g].name];for(let E=0;E<B.width;E++){Dr.value=(l*(B.channels*B.width)+g*B.width+E)*B.inputSize;const w=(B.height-1-c)*(B.width*B.outputChannels)+E*B.outputChannels+v;B.byteArray[w]=B.getter(s,Dr)}}}}return{header:qe,width:B.width,height:B.height,data:B.byteArray,format:B.format,[Je?"colorSpace":"encoding"]:B[Je?"colorSpace":"encoding"],type:this.type}}setDataType(t){return this.type=t,this}load(t,a,o,u){function d(h,f){Je?h.colorSpace=f.colorSpace:h.encoding=f.encoding,h.minFilter=xe,h.magFilter=xe,h.generateMipmaps=!1,h.flipY=!1,a&&a(h,f)}return super.load(t,d,o,u)}}const ya=3e3,Sa=3001,Qr=(i,t,a)=>{let o;switch(i){case mr:o=new Uint8ClampedArray(t*a*4);break;case Me:o=new Uint16Array(t*a*4);break;case qt:o=new Uint32Array(t*a*4);break;case Vt:o=new Int8Array(t*a*4);break;case Yt:o=new Int16Array(t*a*4);break;case Xt:o=new Int32Array(t*a*4);break;case Oe:o=new Float32Array(t*a*4);break;default:throw new Error("Unsupported data type")}return o};let lr;const Ma=(i,t,a,o)=>{if(lr!==void 0)return lr;const u=new Gr(1,1,o);t.setRenderTarget(u);const d=new Er(new Zr,new $t({color:16777215}));t.render(d,a),t.setRenderTarget(null);const h=Qr(i,u.width,u.height);return t.readRenderTargetPixels(u,0,0,u.width,u.height,h),u.dispose(),d.geometry.dispose(),d.material.dispose(),lr=h[0]!==0,lr};class Sr{constructor(t){oe(this,"_renderer");oe(this,"_rendererIsDisposable",!1);oe(this,"_material");oe(this,"_scene");oe(this,"_camera");oe(this,"_quad");oe(this,"_renderTarget");oe(this,"_width");oe(this,"_height");oe(this,"_type");oe(this,"_colorSpace");oe(this,"_supportsReadPixels",!0);oe(this,"render",()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(t){throw this._renderer.setRenderTarget(null),t}this._renderer.setRenderTarget(null)});var o,u,d,h,f,p,m,C,R,x,D,L,ce,P,ee,re;this._width=t.width,this._height=t.height,this._type=t.type,this._colorSpace=t.colorSpace;const a={format:tr,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:((o=t.renderTargetOptions)==null?void 0:o.anisotropy)!==void 0?(u=t.renderTargetOptions)==null?void 0:u.anisotropy:1,generateMipmaps:((d=t.renderTargetOptions)==null?void 0:d.generateMipmaps)!==void 0?(h=t.renderTargetOptions)==null?void 0:h.generateMipmaps:!1,magFilter:((f=t.renderTargetOptions)==null?void 0:f.magFilter)!==void 0?(p=t.renderTargetOptions)==null?void 0:p.magFilter:xe,minFilter:((m=t.renderTargetOptions)==null?void 0:m.minFilter)!==void 0?(C=t.renderTargetOptions)==null?void 0:C.minFilter:xe,samples:((R=t.renderTargetOptions)==null?void 0:R.samples)!==void 0?(x=t.renderTargetOptions)==null?void 0:x.samples:void 0,wrapS:((D=t.renderTargetOptions)==null?void 0:D.wrapS)!==void 0?(L=t.renderTargetOptions)==null?void 0:L.wrapS:ke,wrapT:((ce=t.renderTargetOptions)==null?void 0:ce.wrapT)!==void 0?(P=t.renderTargetOptions)==null?void 0:P.wrapT:ke};if(this._material=t.material,t.renderer?this._renderer=t.renderer:(this._renderer=Sr.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new zr,this._camera=new Zt,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!Ma(this._type,this._renderer,this._camera,a)){let le;switch(this._type){case Me:le=this._renderer.extensions.has("EXT_color_buffer_float")?Oe:void 0;break}le!==void 0?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${Oe}`),this._type=le):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new Er(new Zr,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new Gr(this.width,this.height,a),this._renderTarget.texture.mapping=((ee=t.renderTargetOptions)==null?void 0:ee.mapping)!==void 0?(re=t.renderTargetOptions)==null?void 0:re.mapping:hr}static instantiateRenderer(){const t=new Gt;return t.setSize(128,128),t}toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const t=Qr(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,t),t}toDataTexture(t){const a=new Wt(this.toArray(),this.width,this.height,tr,this._type,(t==null?void 0:t.mapping)||hr,(t==null?void 0:t.wrapS)||ke,(t==null?void 0:t.wrapT)||ke,(t==null?void 0:t.magFilter)||xe,(t==null?void 0:t.minFilter)||xe,(t==null?void 0:t.anisotropy)||1,fr);return a.generateMipmaps=(t==null?void 0:t.generateMipmaps)!==void 0?t==null?void 0:t.generateMipmaps:!1,a}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(t){this.disposeOnDemandRenderer(),t&&this.renderTarget.dispose(),this.material instanceof yr&&Object.values(this.material.uniforms).forEach(a=>{a.value instanceof Ge&&a.value.dispose()}),Object.values(this.material).forEach(a=>{a instanceof Ge&&a.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(t){this._width=t,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(t){this._height=t,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(t){this._renderTarget=t,this._width=t.width,this._height=t.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}class Jr extends Error{}class jr extends Error{}const je=(i,t,a)=>{const o=new RegExp(`${t}="([^"]*)"`,"i").exec(i);if(o)return o[1];const u=new RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i").exec(i);if(u){const d=u[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return d&&d.length===3?d.map(h=>h.replace(/<\/?rdf:li>/g,"")):u[1].trim()}if(a!==void 0)return a;throw new Error(`Can't find ${t} in gainmap metadata`)},Ia=i=>{let t;typeof TextDecoder<"u"?t=new TextDecoder().decode(i):t=i.toString();let a=t.indexOf("<x:xmpmeta");for(;a!==-1;){const o=t.indexOf("x:xmpmeta>",a),u=t.slice(a,o+10);try{const d=je(u,"hdrgm:GainMapMin","0"),h=je(u,"hdrgm:GainMapMax"),f=je(u,"hdrgm:Gamma","1"),p=je(u,"hdrgm:OffsetSDR","0.015625"),m=je(u,"hdrgm:OffsetHDR","0.015625"),C=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(u),R=C?C[1]:"0",x=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(u);if(!x)throw new Error("Incomplete gainmap metadata");const D=x[1];return{gainMapMin:Array.isArray(d)?d.map(L=>parseFloat(L)):[parseFloat(d),parseFloat(d),parseFloat(d)],gainMapMax:Array.isArray(h)?h.map(L=>parseFloat(L)):[parseFloat(h),parseFloat(h),parseFloat(h)],gamma:Array.isArray(f)?f.map(L=>parseFloat(L)):[parseFloat(f),parseFloat(f),parseFloat(f)],offsetSdr:Array.isArray(p)?p.map(L=>parseFloat(L)):[parseFloat(p),parseFloat(p),parseFloat(p)],offsetHdr:Array.isArray(m)?m.map(L=>parseFloat(L)):[parseFloat(m),parseFloat(m),parseFloat(m)],hdrCapacityMin:parseFloat(R),hdrCapacityMax:parseFloat(D)}}catch{}a=t.indexOf("<x:xmpmeta",o)}};class Ta{constructor(t){oe(this,"options");this.options={debug:t&&t.debug!==void 0?t.debug:!1,extractFII:t&&t.extractFII!==void 0?t.extractFII:!0,extractNonFII:t&&t.extractNonFII!==void 0?t.extractNonFII:!0}}extract(t){return new Promise((a,o)=>{const u=this.options.debug,d=new DataView(t.buffer);if(d.getUint16(0)!==65496){o(new Error("Not a valid jpeg"));return}const h=d.byteLength;let f=2,p=0,m;for(;f<h;){if(++p>250){o(new Error(`Found no marker after ${p} loops ðŸ˜µ`));return}if(d.getUint8(f)!==255){o(new Error(`Not a valid marker at offset 0x${f.toString(16)}, found: 0x${d.getUint8(f).toString(16)}`));return}if(m=d.getUint8(f+1),u&&console.log(`Marker: ${m.toString(16)}`),m===226){u&&console.log("Found APP2 marker (0xffe2)");const C=f+4;if(d.getUint32(C)===1297106432){const R=C+4;let x;if(d.getUint16(R)===18761)x=!1;else if(d.getUint16(R)===19789)x=!0;else{o(new Error("No valid endianness marker found in TIFF header"));return}if(d.getUint16(R+2,!x)!==42){o(new Error("Not valid TIFF data! (no 0x002A marker)"));return}const D=d.getUint32(R+4,!x);if(D<8){o(new Error("Not valid TIFF data! (First offset less than 8)"));return}const L=R+D,ce=d.getUint16(L,!x),P=L+2;let ee=0;for(let z=P;z<P+12*ce;z+=12)d.getUint16(z,!x)===45057&&(ee=d.getUint32(z+8,!x));const le=L+2+ce*12+4,ue=[];for(let z=le;z<le+ee*16;z+=16){const N={MPType:d.getUint32(z,!x),size:d.getUint32(z+4,!x),dataOffset:d.getUint32(z+8,!x),dependantImages:d.getUint32(z+12,!x),start:-1,end:-1,isFII:!1};N.dataOffset?(N.start=R+N.dataOffset,N.isFII=!1):(N.start=0,N.isFII=!0),N.end=N.start+N.size,ue.push(N)}if(this.options.extractNonFII&&ue.length){const z=new Blob([d]),N=[];for(const te of ue){if(te.isFII&&!this.options.extractFII)continue;const S=z.slice(te.start,te.end+1,"image/jpeg");N.push(S)}a(N)}}}f+=2+d.getUint16(f+2)}})}}const ba=async i=>{const t=Ia(i);if(!t)throw new jr("Gain map XMP metadata not found");const o=await new Ta({extractFII:!0,extractNonFII:!0}).extract(i);if(o.length!==2)throw new Jr("Gain map recovery image not found");return{sdr:new Uint8Array(await o[0].arrayBuffer()),gainMap:new Uint8Array(await o[1].arrayBuffer()),metadata:t}},Hr=i=>new Promise((t,a)=>{const o=document.createElement("img");o.onload=()=>{t(o)},o.onerror=u=>{a(u)},o.src=URL.createObjectURL(i)});class Ca extends Kt{constructor(a,o){super(o);oe(this,"_renderer");oe(this,"_renderTargetOptions");oe(this,"_internalLoadingManager");oe(this,"_config");this._config=a,a.renderer&&(this._renderer=a.renderer),this._internalLoadingManager=new Qt}setRenderer(a){return this._renderer=a,this}setRenderTargetOptions(a){return this._renderTargetOptions=a,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: A Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");const a=this._config.createMaterial({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new Ge,sdr:new Ge});return this._config.createQuadRenderer({width:16,height:16,type:Me,colorSpace:fr,material:a,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async processImages(a,o,u){const d=o?new Blob([o],{type:"image/jpeg"}):void 0,h=new Blob([a],{type:"image/jpeg"});let f,p,m=!1;if(typeof createImageBitmap>"u"){const C=await Promise.all([d?Hr(d):Promise.resolve(void 0),Hr(h)]);p=C[0],f=C[1],m=u==="flipY"}else{const C=await Promise.all([d?createImageBitmap(d,{imageOrientation:u||"flipY"}):Promise.resolve(void 0),createImageBitmap(h,{imageOrientation:u||"flipY"})]);p=C[0],f=C[1]}return{sdrImage:f,gainMapImage:p,needsFlip:m}}createTextures(a,o,u){const d=new Ge(o||new ImageData(2,2),hr,ke,ke,xe,Lr,tr,mr,1,fr);d.flipY=u,d.needsUpdate=!0;const h=new Ge(a,hr,ke,ke,xe,Lr,tr,mr,1,Jt);return h.flipY=u,h.needsUpdate=!0,{gainMap:d,sdr:h}}updateQuadRenderer(a,o,u,d,h){a.width=o.width,a.height=o.height,a.material.gainMap=u,a.material.sdr=d,a.material.gainMapMin=h.gainMapMin,a.material.gainMapMax=h.gainMapMax,a.material.offsetHdr=h.offsetHdr,a.material.offsetSdr=h.offsetSdr,a.material.gamma=h.gamma,a.material.hdrCapacityMin=h.hdrCapacityMin,a.material.hdrCapacityMax=h.hdrCapacityMax,a.material.maxDisplayBoost=Math.pow(2,h.hdrCapacityMax),a.material.needsUpdate=!0}}const Ra=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,xa=`
// min half float value
#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )
// max half float value
#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )

uniform sampler2D sdr;
uniform sampler2D gainMap;
uniform vec3 gamma;
uniform vec3 offsetHdr;
uniform vec3 offsetSdr;
uniform vec3 gainMapMin;
uniform vec3 gainMapMax;
uniform float weightFactor;

varying vec2 vUv;

void main() {
  vec3 rgb = texture2D( sdr, vUv ).rgb;
  vec3 recovery = texture2D( gainMap, vUv ).rgb;
  vec3 logRecovery = pow( recovery, gamma );
  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;
  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;
  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));
  gl_FragColor = vec4( clampedHdrColor , 1.0 );
}
`;class Aa extends yr{constructor({gamma:a,offsetHdr:o,offsetSdr:u,gainMapMin:d,gainMapMax:h,maxDisplayBoost:f,hdrCapacityMin:p,hdrCapacityMax:m,sdr:C,gainMap:R}){super({name:"GainMapDecoderMaterial",vertexShader:Ra,fragmentShader:xa,uniforms:{sdr:{value:C},gainMap:{value:R},gamma:{value:new Qe(1/a[0],1/a[1],1/a[2])},offsetHdr:{value:new Qe().fromArray(o)},offsetSdr:{value:new Qe().fromArray(u)},gainMapMin:{value:new Qe().fromArray(d)},gainMapMax:{value:new Qe().fromArray(h)},weightFactor:{value:(Math.log2(f)-p)/(m-p)}},blending:jt,depthTest:!1,depthWrite:!1});oe(this,"_maxDisplayBoost");oe(this,"_hdrCapacityMin");oe(this,"_hdrCapacityMax");this._maxDisplayBoost=f,this._hdrCapacityMin=p,this._hdrCapacityMax=m,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(a){this.uniforms.sdr.value=a}get gainMap(){return this.uniforms.gainMap.value}set gainMap(a){this.uniforms.gainMap.value=a}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(a){this.uniforms.offsetHdr.value.fromArray(a)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(a){this.uniforms.offsetSdr.value.fromArray(a)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(a){this.uniforms.gainMapMin.value.fromArray(a)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(a){this.uniforms.gainMapMax.value.fromArray(a)}get gamma(){const a=this.uniforms.gamma.value;return[1/a.x,1/a.y,1/a.z]}set gamma(a){const o=this.uniforms.gamma.value;o.x=1/a[0],o.y=1/a[1],o.z=1/a[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(a){this._hdrCapacityMin=a,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(a){this._hdrCapacityMax=a,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(a){this._maxDisplayBoost=Math.max(1,Math.min(65504,a)),this.calculateWeight()}calculateWeight(){const a=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,a))}}class et extends Ca{constructor(t,a){super({renderer:t,createMaterial:o=>new Aa(o),createQuadRenderer:o=>new Sr(o)},a)}async render(t,a,o,u){const{sdrImage:d,gainMapImage:h,needsFlip:f}=await this.processImages(o,u,"flipY"),{gainMap:p,sdr:m}=this.createTextures(d,h,f);this.updateQuadRenderer(t,d,p,m,a),t.render()}}class Fa extends et{load([t,a,o],u,d,h){const f=this.prepareQuadRenderer();let p,m,C;const R=async()=>{if(p&&m&&C){try{await this.render(f,C,p,m)}catch(I){this.manager.itemError(t),this.manager.itemError(a),this.manager.itemError(o),typeof h=="function"&&h(I),f.disposeOnDemandRenderer();return}typeof u=="function"&&u(f),this.manager.itemEnd(t),this.manager.itemEnd(a),this.manager.itemEnd(o),f.disposeOnDemandRenderer()}};let x=!0,D=0,L=0,ce=!0,P=0,ee=0,re=!0,le=0,ue=0;const z=()=>{if(typeof d=="function"){const I=D+P+le,H=L+ee+ue,W=x&&ce&&re;d(new ProgressEvent("progress",{lengthComputable:W,loaded:H,total:I}))}};this.manager.itemStart(t),this.manager.itemStart(a),this.manager.itemStart(o);const N=new cr(this._internalLoadingManager);N.setResponseType("arraybuffer"),N.setRequestHeader(this.requestHeader),N.setPath(this.path),N.setWithCredentials(this.withCredentials),N.load(t,async I=>{if(typeof I=="string")throw new Error("Invalid sdr buffer");p=I,await R()},I=>{x=I.lengthComputable,L=I.loaded,D=I.total,z()},I=>{this.manager.itemError(t),typeof h=="function"&&h(I)});const te=new cr(this._internalLoadingManager);te.setResponseType("arraybuffer"),te.setRequestHeader(this.requestHeader),te.setPath(this.path),te.setWithCredentials(this.withCredentials),te.load(a,async I=>{if(typeof I=="string")throw new Error("Invalid gainmap buffer");m=I,await R()},I=>{ce=I.lengthComputable,ee=I.loaded,P=I.total,z()},I=>{this.manager.itemError(a),typeof h=="function"&&h(I)});const S=new cr(this._internalLoadingManager);return S.setRequestHeader(this.requestHeader),S.setPath(this.path),S.setWithCredentials(this.withCredentials),S.load(o,async I=>{if(typeof I!="string")throw new Error("Invalid metadata string");C=JSON.parse(I),await R()},I=>{re=I.lengthComputable,ue=I.loaded,le=I.total,z()},I=>{this.manager.itemError(o),typeof h=="function"&&h(I)}),f}}class Ua extends et{load(t,a,o,u){const d=this.prepareQuadRenderer(),h=new cr(this._internalLoadingManager);return h.setResponseType("arraybuffer"),h.setRequestHeader(this.requestHeader),h.setPath(this.path),h.setWithCredentials(this.withCredentials),this.manager.itemStart(t),h.load(t,async f=>{if(typeof f=="string")throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const p=new Uint8Array(f);let m,C,R;try{const x=await ba(p);m=x.sdr,C=x.gainMap,R=x.metadata}catch(x){if(x instanceof jr||x instanceof Jr)console.warn(`Failure to reconstruct an HDR image from ${t}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),R={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},m=p;else throw x}try{await this.render(d,R,m.buffer,C==null?void 0:C.buffer)}catch(x){this.manager.itemError(t),typeof u=="function"&&u(x),d.disposeOnDemandRenderer();return}typeof a=="function"&&a(d),this.manager.itemEnd(t),d.disposeOnDemandRenderer()},o,f=>{this.manager.itemError(t),typeof u=="function"&&u(f)}),d}}const ar={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},rt="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",We=i=>Array.isArray(i),Mr=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"];function dr({files:i=Mr,path:t="",preset:a=void 0,encoding:o=void 0,extensions:u}={}){let d=null,h=!1;a&&(Ir(a),i=ar[a],t=rt),h=We(i);const{extension:f,isCubemap:p}=Tr(i);if(d=br(f),!d)throw new Error("useEnvironment: Unrecognized file extension: "+i);const m=rr(D=>D.gl);V.useLayoutEffect(()=>{if(f!=="webp"&&f!=="jpg"&&f!=="jpeg")return;function D(){ur.clear(d,h?[i]:i)}m.domElement.addEventListener("webglcontextlost",D,{once:!0})},[i,m.domElement]);const C=ur(d,h?[i]:i,D=>{(f==="webp"||f==="jpg"||f==="jpeg")&&D.setRenderer(m),D.setPath==null||D.setPath(t),u&&u(D)});let R=h?C[0]:C;if(f==="jpg"||f==="jpeg"||f==="webp"){var x;R=(x=R.renderTarget)==null?void 0:x.texture}return R.mapping=p?ea:ra,"colorSpace"in R?R.colorSpace=o??p?"srgb":"srgb-linear":R.encoding=o??p?Sa:ya,R}const Oa={files:Mr,path:"",preset:void 0,extensions:void 0};dr.preload=i=>{const t={...Oa,...i};let{files:a,path:o=""}=t;const{preset:u,extensions:d}=t;u&&(Ir(u),a=ar[u],o=rt);const{extension:h}=Tr(a);if(h==="webp"||h==="jpg"||h==="jpeg")throw new Error("useEnvironment: Preloading gainmaps is not supported");const f=br(h);if(!f)throw new Error("useEnvironment: Unrecognized file extension: "+a);ur.preload(f,We(a)?[a]:a,p=>{p.setPath==null||p.setPath(o),d&&d(p)})};const Na={files:Mr,preset:void 0};dr.clear=i=>{const t={...Na,...i};let{files:a}=t;const{preset:o}=t;o&&(Ir(o),a=ar[o]);const{extension:u}=Tr(a),d=br(u);if(!d)throw new Error("useEnvironment: Unrecognized file extension: "+a);ur.clear(d,We(a)?[a]:a)};function Ir(i){if(!(i in ar))throw new Error("Preset must be one of: "+Object.keys(ar).join(", "))}function Tr(i){var t;const a=We(i)&&i.length===6,o=We(i)&&i.length===3&&i.some(h=>h.endsWith("json")),u=We(i)?i[0]:i;return{extension:a?"cube":o?"webp":u.startsWith("data:application/exr")?"exr":u.startsWith("data:application/hdr")?"hdr":u.startsWith("data:image/jpeg")?"jpg":(t=u.split(".").pop())==null||(t=t.split("?"))==null||(t=t.shift())==null?void 0:t.toLowerCase(),isCubemap:a,isGainmap:o}}function br(i){return i==="cube"?ta:i==="hdr"?wa:i==="exr"?Ea:i==="jpg"||i==="jpeg"?Ua:i==="webp"?Fa:null}const Ba=i=>i.current&&i.current.isScene,Da=i=>Ba(i)?i.current:i;function Cr(i,t,a,o,u={}){var d,h,f,p;u={backgroundBlurriness:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...u};const m=Da(t||a),C=m.background,R=m.environment,x={backgroundBlurriness:m.backgroundBlurriness,backgroundIntensity:m.backgroundIntensity,backgroundRotation:(d=(h=m.backgroundRotation)==null||h.clone==null?void 0:h.clone())!==null&&d!==void 0?d:[0,0,0],environmentIntensity:m.environmentIntensity,environmentRotation:(f=(p=m.environmentRotation)==null||p.clone==null?void 0:p.clone())!==null&&f!==void 0?f:[0,0,0]};return i!=="only"&&(m.environment=o),i&&(m.background=o),kr(m,u),()=>{i!=="only"&&(m.environment=R),i&&(m.background=C),kr(m,x)}}function Rr({scene:i,background:t=!1,map:a,...o}){const u=rr(d=>d.scene);return V.useLayoutEffect(()=>{if(a)return Cr(t,i,u,a,o)}),null}function tt({background:i=!1,scene:t,blur:a,backgroundBlurriness:o,backgroundIntensity:u,backgroundRotation:d,environmentIntensity:h,environmentRotation:f,...p}){const m=dr(p),C=rr(R=>R.scene);return V.useLayoutEffect(()=>Cr(i,t,C,m,{backgroundBlurriness:a??o,backgroundIntensity:u,backgroundRotation:d,environmentIntensity:h,environmentRotation:f})),V.useEffect(()=>()=>{m.dispose()},[m]),null}function ka({children:i,near:t=.1,far:a=1e3,resolution:o=256,frames:u=1,map:d,background:h=!1,blur:f,backgroundBlurriness:p,backgroundIntensity:m,backgroundRotation:C,environmentIntensity:R,environmentRotation:x,scene:D,files:L,path:ce,preset:P=void 0,extensions:ee}){const re=rr(S=>S.gl),le=rr(S=>S.scene),ue=V.useRef(null),[z]=V.useState(()=>new zr),N=V.useMemo(()=>{const S=new aa(o);return S.texture.type=Me,S},[o]);V.useEffect(()=>()=>{N.dispose()},[N]),V.useLayoutEffect(()=>{if(u===1){const S=re.autoClear;re.autoClear=!0,ue.current.update(re,z),re.autoClear=S}return Cr(h,D,le,N.texture,{backgroundBlurriness:f??p,backgroundIntensity:m,backgroundRotation:C,environmentIntensity:R,environmentRotation:x})},[i,z,N.texture,D,le,h,u,re]);let te=1;return kt(()=>{if(u===1/0||te<u){const S=re.autoClear;re.autoClear=!0,ue.current.update(re,z),re.autoClear=S,te++}}),V.createElement(V.Fragment,null,Lt(V.createElement(V.Fragment,null,i,V.createElement("cubeCamera",{ref:ue,args:[t,a,N]}),L||P?V.createElement(tt,{background:!0,files:L,preset:P,path:ce,extensions:ee}):d?V.createElement(Rr,{background:!0,map:d,extensions:ee}):null),z))}function La(i){var t,a,o,u;const d=dr(i),h=i.map||d;V.useMemo(()=>Bt({GroundProjectedEnvImpl:_a}),[]),V.useEffect(()=>()=>{d.dispose()},[d]);const f=V.useMemo(()=>[h],[h]),p=(t=i.ground)==null?void 0:t.height,m=(a=i.ground)==null?void 0:a.radius,C=(o=(u=i.ground)==null?void 0:u.scale)!==null&&o!==void 0?o:1e3;return V.createElement(V.Fragment,null,V.createElement(Rr,Dt({},i,{map:h})),V.createElement("groundProjectedEnvImpl",{args:f,scale:C,height:p,radius:m}))}function Wa(i){return i.ground?V.createElement(La,i):i.map?V.createElement(Rr,i):i.children?V.createElement(ka,i):V.createElement(tt,i)}export{Wa as E};
